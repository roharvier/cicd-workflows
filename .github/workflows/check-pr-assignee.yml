name: Check PR Assignee

on:
  workflow_call:
    inputs:
      fail_if_no_assignee:
        description: 'Fail if no assignee is found'
        required: false
        type: boolean
        default: true
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-assignee:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if PR has an assignee
        id: check_assignee
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FAIL_IF_NO_ASSIGNEE: ${{ inputs.fail_if_no_assignee }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.number }}
        run: |
          set -e
          
          # Récupérer les informations de la PR
          PR_DATA=$(gh pr view "$PR_NUMBER" --json assignees)
          ASSIGNEES_COUNT=$(echo "$PR_DATA" | jq '.assignees | length')
          
          if [ "$ASSIGNEES_COUNT" -eq 0 ]; then
            HAS_ASSIGNEE=false
            
            if [ "$FAIL_IF_NO_ASSIGNEE" = "true" ]; then
              echo "❌ Cette Pull Request doit avoir au moins un assignee."
              exit 1
            else
              echo "::warning::⚠️ Cette Pull Request n'a pas d'assignee."
            fi
            
            # Ajouter un commentaire sur la PR
            gh pr comment "$PR_NUMBER" --body "⚠️ **Rappel**: Cette Pull Request doit avoir au moins un assignee avant d'être mergée."
          else
            HAS_ASSIGNEE=true
            echo "✅ La Pull Request a au moins un assignee."
          fi
          
          echo "has_assignee=$HAS_ASSIGNEE" >> $GITHUB_OUTPUT
